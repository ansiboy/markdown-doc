/*!
 * 
 *  maishu-chitu v3.27.0
 *  https://github.com/ansiboy/chitu
 *  
 *  Copyright (c) 2016-2018, shu mai <ansiboy@163.com>
 *  Licensed under the MIT License.
 * 
 */
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("maishu-chitu-service"));else if("function"==typeof define&&define.amd)define(["maishu-chitu-service"],t);else{var r="object"==typeof exports?t(require("maishu-chitu-service")):t(e["maishu-chitu-service"]);for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}("undefined"==typeof window?global:window,function(e){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5)}([function(t,r){t.exports=e},function(e,t,r){var n,a;n=[r,t,r(0),r(3),r(2)],void 0===(a=function(e,t,r,n,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i="index";function s(e){if(!e)throw a.Errors.argumentNull("url");let t,r,n=e.indexOf("#");if(!(t=n>=0?e.substr(n+1):e))throw a.Errors.canntParseRouteString(e);if(t.startsWith("!"))throw a.Errors.canntParseRouteString(t);let s=null,o=t.indexOf("?");o>=0?(s=t.substr(o+1),r=t.substring(0,o)):r=t,r||(r=i);let l={};return s&&(l=function(e){let t,r=/\+/g,n=/([^&=]+)=?([^&]*)/g,a=function(e){return decodeURIComponent(e.replace(r," "))},i={};for(;t=n.exec(e);)i[a(t[1])]=a(t[2]);return i}(s)),{pageName:r,values:l}}function o(e,t){let r=e.split(".").join("/");if(!t)return`${r}`;let n="";for(let e in t){let r=t[e];"function"!=typeof r&&null!=r&&(r=encodeURIComponent(r),n=""==n?`?${e}=${r}`:n+`&${e}=${r}`)}return`${r}${n}`}t.parseUrl=s,t.createPageUrl=o;class l extends n.PageMaster{constructor(e){super(l.containers((e||{}).container),(e||{}).parser),this._runned=!1}static containers(e){let t={};if(null==e)return t[l.DefaultContainerName]=document.body,t;if(e.tagName)return t[l.DefaultContainerName]=e,t;if(t=e,!l.DefaultContainerName)throw a.Errors.containerIsNotExists(l.DefaultContainerName);return t}parseUrl(e){if(!e)throw a.Errors.argumentNull("url");return s(e)}createUrl(e,t){return o(e,t)}run(){if(this._runned)return;let e=()=>{let e=location.href,t=e.indexOf("#");(e=t<0?"#"+i:e.substr(t+1)).startsWith("!")||this.showPage(e)};e(),window.addEventListener("hashchange",()=>{this.location.skip?delete this.location.skip:e()}),this._runned=!0}setLocationHash(e){this.location.hash=`#${e}`,this.location.skip=!0}get location(){return location}redirect(e,t){if(!e)throw a.Errors.argumentNull("pageUrl");let r=this.showPage(e,t),n=this.createUrl(r.name,r.data);return this.setLocationHash(n),r}forward(e,t,r){if(!e)throw a.Errors.argumentNull("pageNameOrUrl");null==r&&(r=!0);let n=this.showPage(e,t,!0);if(r){let e=this.createUrl(n.name,n.data);this.setLocationHash(e)}return n}back(){this.closeCurrentPage(),setTimeout(()=>{history.back()},100)}createService(e){let t=new(e=e||r.Service);return t.error.add((e,t)=>{this.error.fire(this,t,null)}),t}}t.Application=l,l.DefaultContainerName="default"}.apply(t,n))||(e.exports=a)},function(e,t,r){var n;void 0===(n=function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Errors=class{static pageNodeNotExists(e){return new Error(`Page node named ${e} is not exists.`)}static actionCanntNull(e){return new Error(`Action of '${e}' can not be null.`)}static argumentNull(e){return new Error(`The argument "${e}" cannt be null.`)}static modelFileExpecteFunction(e){return new Error(`The eval result of script file "${e}" is expected a function.`)}static paramTypeError(e,t){return new Error(`The param "${e}" is expected "${t}" type.`)}static paramError(e){return new Error(e)}static pathPairRequireView(e){return new Error(`The view value is required for path pair, but the item with index "${e}" is miss it.`)}static notImplemented(e){return new Error(`'The method "${e}" is not implemented.'`)}static routeExists(e){return new Error(`Route named "${e}" is exists.`)}static noneRouteMatched(e){return new Error(`None route matched with url "${e}".`)}static emptyStack(){return new Error("The stack is empty.")}static canntParseUrl(e){return new Error(`Can not parse the url "${e}" to route data.`)}static canntParseRouteString(e){return new Error(`Can not parse the route string "${e}" to route data.;`)}static routeDataRequireController(){return new Error('The route data does not contains a "controller" file.')}static routeDataRequireAction(){return new Error('The route data does not contains a "action" file.')}static viewCanntNull(){return new Error("The view or viewDeferred of the page cannt null.")}static createPageFail(e){return new Error(`Create page "${e}" fail.`)}static actionTypeError(e){return new Error(`The action in page '${e}' is expect as function.`)}static canntFindAction(e){return new Error(`Cannt find action in page '${e}', is the exports has default field?`)}static exportsCanntNull(e){return new Error(`Exports of page '${e}' is null.`)}static scrollerElementNotExists(){return new Error("Scroller element is not exists.")}static resourceExists(e,t){return new Error(`Rosource '${e}' is exists in the resources of page '${t}'.`)}static siteMapRootCanntNull(){return new Error("The site map root node can not be null.")}static duplicateSiteMapNode(e){return new Error(`The site map node ${e} is exists.`)}static unexpectedNullValue(){return new Error("Unexpected null value.")}static containerIsNotExists(e){return new Error(`Container '${e}' is not exists`)}}}.apply(t,[r,t]))||(e.exports=n)},function(e,t,r){var n,a,i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(a,i){function s(e){try{l(n.next(e))}catch(e){i(e)}}function o(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,o)}l((n=n.apply(e,t||[])).next())})};n=[r,t,r(0),r(4),r(1),r(2)],void 0===(a=function(e,t,r,n,a,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class o{constructor(e,t){if(this.pageCreated=r.Callbacks(),this.pageShowing=r.Callbacks(),this.pageShown=r.Callbacks(),this.pageType=n.Page,this.pageDisplayType=n.PageDisplayerImplement,this.cachePages={},this.page_stack=new Array,this.nodes={},this.MAX_PAGE_COUNT=100,this.pageTagName="div",this.pagePlaceholder=o.defaultPagePlaceholder,this.error=r.Callbacks(),this._defaultPageNodeParser=null,this.parser=t||this.defaultPageNodeParser,!e)throw s.Errors.argumentNull("containers");this.parser.actions=this.parser.actions||{},this.containers=e,this.pageContainers={}}sendMessage(e,t,r){let n;(n="string"==typeof t?this.page_stack.filter(e=>e.name==t):this.page_stack.filter(e=>e instanceof t)).forEach(t=>{t.messageReceived.fire(e,r)})}get defaultPageNodeParser(){if(null==this._defaultPageNodeParser){let e={};this._defaultPageNodeParser={actions:{},parse:t=>{let r=e[t];if(null==r){let n=`modules_${t}`.split("_").join("/");r={action:this.createDefaultAction(n,this.loadjs),name:t},e[t]=r}return r}}}return this._defaultPageNodeParser}createDefaultAction(e,t){return r=>i(this,void 0,void 0,function*(){let n=yield t(e);if(!n)throw s.Errors.exportsCanntNull(e);let a,i=n.default;if(null==i)throw s.Errors.canntFindAction(r.name);if(o.isClass(i)){a=new i(r,this)}else{a=i(r,this)}return a})}loadjs(e){return new Promise((t,r)=>{requirejs([e],function(e){t(e)},function(e){r(e)})})}on_pageCreated(e){return this.pageCreated.fire(this,e)}get currentPage(){return this.page_stack.length>0?this.page_stack[this.page_stack.length-1]:null}cachePageKey(e,t){return`${e}_${t}`}getPage(e,t,r){if(!e)throw s.Errors.argumentNull("pageUrl");let n=this.cachePageKey(t,e);r=r||{};let i=this.cachePages[n];if(null!=i){let t=a.parseUrl(e);return i.data=Object.assign(r||{},t.values),{page:i,isNew:!1}}let o=this.createPage(e,t,r);return this.cachePages[n]=o,this.on_pageCreated(o),{page:o,isNew:!0}}createPage(e,t,r){if(!e)throw s.Errors.argumentNull("pageUrl");if(!t)throw s.Errors.argumentNull("containerName");r=r||{};let n=a.parseUrl(e),i=this.createPageElement(n.pageName,t),o=new this.pageDisplayType(this),l=this.containers[t];if(!l)throw s.Errors.containerIsNotExists(t);console.assert(null!=this.pageType);let u=new this.pageType({app:this,url:e,data:r,displayer:o,element:i,container:{name:t,element:l}}),c=e=>{for(let t in this.containers)t==e.container.name?e.container.element.style.removeProperty("display"):this.containers[t].style.display="none";this.pageShowing.fire(this,e)},h=e=>{this.pageShown.fire(this,e)};return u.showing.add(c),u.shown.add(h),u.closed.add(()=>{u.showing.remove(c),u.shown.remove(h);let e=this.cachePageKey(u.container.name,u.url);delete this.cachePages[e],this.page_stack=this.page_stack.filter(e=>e!=u)}),u}createPageElement(e,t){if(!t)throw s.Errors.argumentNull("containerName");let r=this.containers[t];if(!r)throw s.Errors.containerIsNotExists(t);let n=r.querySelector(`.${this.pagePlaceholder}`);null==n&&(n=r);let a=document.createElement(this.pageTagName);return n.appendChild(a),a}showPage(e,t,r){t=t||{},r=null!=r;let n={},i={};for(let e in t){let r=t[e];"function"==typeof r?i[e]=r:n[e]=r}let o=a.parseUrl(e);if(n=Object.assign(n,o.values),!(e=a.createPageUrl(o.pageName,n)))throw s.Errors.argumentNull("pageName");if(null!=this.currentPage&&this.currentPage.url==e)return this.currentPage;let l=n.container||this.pageContainers[o.pageName]||a.Application.DefaultContainerName,{page:u,isNew:c}=this.getPage(e,l,t);if(c||r){let t=this.findPageAction(e);if(null==t)throw s.Errors.actionCanntNull(e);t(u,this)}return u.show(),this.pushPage(u),console.assert(u==this.currentPage,"page is not current page"),u}reload(e){let t=this.findPageAction(e.url);console.assert(null!=t),t(e,this)}pushPage(e){if(this.page_stack.push(e),this.page_stack.length>this.MAX_PAGE_COUNT){let e=this.page_stack.shift();e&&e.close()}}findPageAction(e){let t=a.parseUrl(e).pageName,r=this.findPageNode(t);if(null==r)throw s.Errors.pageNodeNotExists(t);if(null==r.action)throw s.Errors.actionCanntNull(t);return r.action}findPageNode(e){if(this.nodes[e])return this.nodes[e];let t=null,r=this.parser.actions?this.parser.actions[e]:null;return null!=r&&(t={action:r,name:e}),null==t&&null!=this.parser.parse&&(t=this.parser.parse(e,this),console.assert(null!=t.action)),null!=t&&(this.nodes[e]=t),t}closeCurrentPage(e){var t=this.page_stack.pop();null!=t&&(t.close(),this.currentPage&&(e&&(console.assert(null!=this.currentPage.data),this.currentPage.data=Object.assign(this.currentPage.data,e)),this.currentPage.show()))}get pageStack(){return this.page_stack}}var l;t.PageMaster=o,o.defaultPagePlaceholder="page-placeholder",o.isClass=(l=Function.prototype.toString,function(e){return"function"==typeof e&&(/^class(\s|\{\}$)/.test(l.call(e))||/^.*classCallCheck\(/.test(function(e){return l.call(e).replace(/^[^{]*{\s*/,"").replace(/\s*}[^}]*$/,"")}(e)))})}.apply(t,n))||(e.exports=a)},function(e,t,r){var n,a;n=[r,t,r(0),r(2),r(1)],void 0===(a=function(e,t,r,n,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Page=class{constructor(e){this.data={},this.showing=r.Callbacks(),this.shown=r.Callbacks(),this.hiding=r.Callbacks(),this.hidden=r.Callbacks(),this.closing=r.Callbacks(),this.closed=r.Callbacks(),this.messageReceived=r.Callbacks(),this._element=e.element,this._app=e.app,this._displayer=e.displayer;let t=a.parseUrl(e.url);this.data=Object.assign(t.values,e.data||{}),this._name=t.pageName,this._url=e.url,this._container=e.container}on_showing(){return this.showing.fire(this,this.data)}on_shown(){return this.shown.fire(this,this.data)}on_hiding(){return this.hiding.fire(this,this.data)}on_hidden(){return this.hidden.fire(this,this.data)}on_closing(){return this.closing.fire(this,this.data)}on_closed(){return this.closed.fire(this,this.data)}show(){this.on_showing();let e=this._app.currentPage;return this==e&&(e=null),this._displayer.show(this,e).then(e=>{this.on_shown()})}hide(e){return this.on_hiding(),this._displayer.hide(this,e).then(e=>{this.on_hidden()})}close(){this.on_closing();let e=this._element.parentElement;if(null==e)throw n.Errors.unexpectedNullValue();return e.removeChild(this._element),this.on_closed(),Promise.resolve()}createService(e){let t=new(e=e||r.Service);return t.error.add((e,t)=>{this._app.error.fire(this._app,t,this)}),t}reload(){this.app.reload(this)}get element(){return this._element}get name(){return this._name}get url(){return this._url}get app(){return this._app}get container(){return this._container}};t.PageDisplayerImplement=class{show(e,t){return e.element.style.display="block",null!=t&&(t.element.style.display="none"),Promise.resolve()}hide(e,t){return e.element.style.display="none",null!=t&&(t.element.style.display="block"),Promise.resolve()}}}.apply(t,n))||(e.exports=a)},function(e,t,r){var n,a;n=[r,t,r(1),r(3),r(4),r(0)],void 0===(a=function(e,t,r,n,a,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Application=r.Application,t.parseUrl=r.parseUrl,t.createPageUrl=r.createPageUrl,t.PageMaster=n.PageMaster,t.Page=a.Page,t.Callback=i.Callback,t.Callbacks=i.Callbacks,t.ValueStore=i.ValueStore,t.Service=i.Service}.apply(t,n))||(e.exports=a)}])});
//# sourceMappingURL=index.min.js.map